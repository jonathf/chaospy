version-tags: &version-tags
  tags:
    only: /\d+\.\d+\.\d+(-\w+)?/

version: 2.1

jobs:
  pipeline:
    docker:
      - image: circleci/python:$PYTHON_VERSION
        auth:
          username: jonathf
          password: $DOCKERHUB_PASSWORD
    working_directory: /home/circleci/project
    environment:
      PYTHON_VERSION: 3.7.10
    steps:
      - checkout
      - run:
          name: "Installation"
          command: |
            sudo apt install pandoc
            python3 -m pip install -U pip
            python3 -m pip install -r requirements-dev.txt
            python3 -m pip install -e .
      - run:
          name: "Check documentation"
          command: |
            sphinx-build docs/ docs/.build -b html -n -v --color -T -W
      - run:
          name: "Run Tests"
          command: |
            pytest --cov chaospy --doctest-modules chaospy/ tests/ README.rst
            bash <(curl -s https://codecov.io/bash)
      - run:
          name: "Publish to PyPI"
          command: |
            if [ -n "$CIRCLE_TAG" ]; then
              python3 -m pip install build twine
              python3 -m build
              python3 -m twine upload -u jonathf -p $PYPI_PASSWORD --non-interactive dist/*
            else
              echo "nothing to do!"
            fi

workflows:
  version: 2
  workflow:
    jobs:
      - pipeline:
          filters:
            <<: *version-tags
