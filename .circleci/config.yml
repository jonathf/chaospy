version-tags: &version-tags
  tags:
    only: /\d+\.\d+\.\d+(-\w+)?/

version: 2.1

jobs:
  pipeline:
    environment:
      PYTHON_VERSION: 3.7.10
    docker:
      - image: cimg/python:$PYTHON_VERSION
        auth:
          username: jonathf
          password: $DOCKERHUB_PASSWORD
    working_directory: /home/circleci/project
    steps:
      - checkout
      - run: sudo chown -R circleci:circleci /usr/local/{bin,lib}
      - restore_cache:
          keys:
            - deps-py37-{{ checksum "setup.cfg" }}
            - deps-py37-
      - run:
          name: "Installation"
          command: |
            if [ ! -d "venv37" ]; then
              python3 -m venv venv37
              sudo chown -R circleci:circleci venv37
              wget https://github.com/jgm/pandoc/releases/download/2.17.1.1/pandoc-2.17.1.1-1-amd64.deb -O venv37/pandoc.deb
            else
              echo "using cached environment"
            fi
            sudo dpkg -i venv37/pandoc*.deb
            venv37/bin/activate
            pip install -U pip
            pip install -r requirements-dev.txt
            pip install -e .
      - run:
          name: "Check documentation"
          command: |
            venv37/bin/activate
            sphinx-build docs/ docs/.build -b html -n -v --color -T -W
      - run:
          name: "Run Tests"
          command: |
            venv37/bin/activate
            pytest --cov chaospy --doctest-modules chaospy/ tests/ README.rst
            bash <(curl -s https://codecov.io/bash)
      - run:
          name: "Publish to PyPI"
          command: |
            venv37/bin/activate
            python -m build
            if [ -n "$CIRCLE_TAG" ]; then
              python -m twine upload -u jonathf -p $PYPI_PASSWORD --non-interactive dist/*
            else
              echo "nothing to do!"
            fi
      - save_cache:
          key: deps-py37-{{ checksum "setup.cfg" }}
          paths:
            - venv37

workflows:
  version: 2
  workflow:
    jobs:
      - pipeline:
          filters:
            <<: *version-tags
